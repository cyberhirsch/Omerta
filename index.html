<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>OMERTÀ: The City of Silence</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg-color: #0d0d0d;
            --panel-color: #1a1a1a;
            --text-color: #dfdfdf;
            --accent-color: #ff3333;
            /* Neon Red */
            --highlight-color: #ffff33;
            /* Neon Yellow */
            --btn-hover: #cc0000;
            --font-main: 'Press Start 2P', cursive;

            /* MATH: Image is 420px wide. One image pixel = 100vw / 420 */
            --pixel: calc(100vw / 420);
        }

        body {
            background-color: var(--bg-color);
            color: var(--text-color);
            font-family: var(--font-main);
            margin: 0;
            padding: 0;
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
            width: 100vw;
            overflow: hidden;
            background-size: contain;
            background-position: center;
            background-repeat: no-repeat;
            background-color: #000;
            transition: background-image 0.8s ease-in-out;
            image-rendering: pixelated;
            image-rendering: crisp-edges;
            position: relative;
        }

        .container {
            position: relative;
            width: 100vw;
            height: 100vh;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            padding: calc(10 * var(--pixel));
            box-sizing: border-box;
            background: radial-gradient(circle, transparent 0%, rgba(0, 0, 0, 0.4) 100%);
            z-index: 10;
        }

        /* Setup Screen */
        #setup-screen {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.95);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 100;
        }

        input[type="number"],
        input[type="text"] {
            padding: calc(4 * var(--pixel));
            font-size: calc(8 * var(--pixel));
            background: #333;
            color: white;
            border: calc(1 * var(--pixel)) solid #555;
            margin: calc(2 * var(--pixel));
            font-family: var(--font-main);
        }

        select {
            padding: calc(4 * var(--pixel));
            font-family: var(--font-main);
            font-size: calc(6 * var(--pixel));
            background: #333;
            color: white;
            border: none;
        }

        h1 {
            margin: 0;
            font-size: calc(16 * var(--pixel));
            color: var(--accent-color);
            text-transform: uppercase;
            letter-spacing: calc(1 * var(--pixel));
        }

        .stats-header {
            display: flex;
            gap: calc(10 * var(--pixel));
            justify-content: center;
            width: 100%;
            flex-wrap: wrap;
            z-index: 20;
        }

        .player-stat-card {
            background: rgba(0, 0, 0, 0.7);
            border: calc(1 * var(--pixel)) solid #444;
            padding: calc(4 * var(--pixel));
            font-size: calc(6 * var(--pixel));
            min-width: calc(80 * var(--pixel));
            position: relative;
        }

        .player-stat-card.active {
            border-color: var(--accent-color);
            background: #200;
            box-shadow: 0 0 calc(10 * var(--pixel)) rgba(255, 51, 51, 0.3);
        }

        .player-stat-card.active::after {
            content: "▶";
            position: absolute;
            left: calc(-12 * var(--pixel));
            top: 50%;
            transform: translateY(-50%);
            color: var(--accent-color);
            font-size: calc(8 * var(--pixel));
        }

        .system-ops {
            display: flex;
            flex-direction: column;
            gap: calc(4 * var(--pixel));
            justify-content: center;
        }

        .scene-container {
            flex-grow: 1;
            display: flex;
            justify-content: center;
            align-items: center;
            width: 100%;
            pointer-events: none;
        }

        .scene-overlay {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            pointer-events: none;
        }

        .story-panel {
            background: rgba(0, 0, 0, 0.85);
            border: calc(2 * var(--pixel)) solid var(--accent-color);
            padding: calc(30 * var(--pixel));
            text-align: center;
            max-width: 80%;
            box-shadow: 0 0 calc(20 * var(--pixel)) #000;
            pointer-events: all;
        }

        #story-text-main {
            font-size: calc(8 * var(--pixel));
            margin-bottom: calc(6 * var(--pixel));
            text-shadow: calc(1 * var(--pixel)) calc(1 * var(--pixel)) 0px #000;
        }

        #story-text-sub {
            font-size: calc(6 * var(--pixel));
            text-shadow: calc(1 * var(--pixel)) calc(1 * var(--pixel)) 0px #000;
        }

        .controls {
            display: flex;
            gap: calc(20 * var(--pixel));
            justify-content: center;
            width: 100%;
            margin-top: calc(10 * var(--pixel));
        }

        button {
            min-width: calc(60 * var(--pixel));
            padding: calc(4 * var(--pixel)) calc(8 * var(--pixel));
            font-size: calc(8 * var(--pixel));
            border: calc(1 * var(--pixel)) solid #666;
            font-family: var(--font-main);
            background: #333;
            color: #fff;
            cursor: pointer;
            text-transform: uppercase;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
        }

        button:hover {
            background: var(--accent-color);
            border-color: #fff;
            box-shadow: 0 0 calc(5 * var(--pixel)) rgba(255, 51, 51, 0.5);
        }

        button:disabled {
            opacity: 0.3;
            cursor: not-allowed;
            background: #111;
            border-color: #333;
        }

        .action-btn {
            background: #444;
            border-color: var(--highlight-color);
            color: var(--highlight-color);
        }

        .action-btn:hover {
            background: var(--highlight-color);
            color: #000;
        }

        .history-section {
            background: #000;
            padding: calc(10 * var(--pixel));
            border: calc(1 * var(--pixel)) solid #222;
            opacity: 0.8;
        }

        #log-container {
            height: calc(50 * var(--pixel));
            font-size: calc(5 * var(--pixel));
            background: transparent;
            border: none;
            padding: 0;
            overflow-y: auto;
            color: #aaa;
        }

        #trade-modal {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: var(--panel-color);
            border: calc(4 * var(--pixel)) solid var(--accent-color);
            padding: calc(30 * var(--pixel));
            z-index: 200;
            width: 90%;
            max-width: calc(600 * var(--pixel));
            box-shadow: 0 0 calc(50 * var(--pixel)) #000;
        }

        .trade-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: calc(10 * var(--pixel));
            margin: calc(10 * var(--pixel)) 0;
            font-size: calc(6 * var(--pixel));
        }

        .trade-col {
            background: #111;
            padding: calc(6 * var(--pixel));
            border: calc(1 * var(--pixel)) solid #444;
            max-height: calc(100 * var(--pixel));
            overflow-y: auto;
        }

        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.85);
            z-index: 150;
        }

        .hidden {
            display: none !important;
        }

        @media (max-width: 700px) {
            #story-text-main {
                font-size: 10px;
            }

            .stats-header {
                gap: 5px;
            }
        }
    </style>
</head>

<body>

    <!-- SETUP OVERLAY -->
    <div id="setup-screen">
        <h1 style="margin-bottom: calc(10 * var(--pixel));">OMERTÀ Setup</h1>
        <div style="margin-bottom: calc(10 * var(--pixel));">
            <label style="font-size: calc(8 * var(--pixel));">Number of Bosses (2-6):</label>
            <input type="number" id="num-players" min="2" max="6" value="2">
        </div>
        <div id="name-inputs" style="display: flex; flex-direction: column; gap: calc(5 * var(--pixel));"></div>
        <button onclick="startGame()" class="action-btn"
            style="width: calc(150 * var(--pixel)); margin-top: calc(10 * var(--pixel));">Start Game</button>
    </div>

    <!-- MAIN UI -->
    <div class="container" id="game-ui" style="display:none;">

        <!-- ALL PLAYER STATS HEADER -->
        <div class="stats-header" id="stats-header">
            <!-- Populated by JS -->
        </div>

        <!-- SCENE BOX -->
        <div class="scene-container" id="scene-bg">
            <div class="scene-overlay">
                <div class="story-panel">
                    <div id="story-text-main">Welcome to the family.</div>
                    <div id="story-text-sub">Waiting for the Boss to make a move...</div>

                    <div class="controls">
                        <button id="btn-buy" onclick="buyProperty()" disabled>Buy Turf</button>
                        <button id="btn-expand" onclick="expandRacket()" class="hidden">Add Muscle</button>
                        <button id="btn-trade" onclick="openTradeModal()">Make Deal</button>
                        <button id="btn-end" onclick="endTurn()" disabled>End Turn</button>
                        <button id="btn-bail" onclick="payBail()" style="display:none;">Pay Bribe ($50)</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- TRADE MODAL (Hidden) -->
        <div id="trade-overlay" class="modal-overlay hidden"></div>
        <div id="trade-modal" class="hidden">
            <h2 id="trade-title"
                style="font-size: calc(10 * var(--pixel)); text-transform: uppercase; color: var(--accent-color); margin-bottom: calc(8 * var(--pixel));">
                Sit Down with another Boss</h2>

            <div style="margin-top: calc(8 * var(--pixel)); font-size: calc(8 * var(--pixel));">
                Deal with: <select id="trade-target"></select>
            </div>

            <div class="trade-grid">
                <div class="trade-col">
                    <div id="trade-off-label"
                        style="color: var(--highlight-color); margin-bottom: calc(4 * var(--pixel));">Your Offer</div>
                    <div id="trade-my-props"></div>
                    <div style="margin-top: calc(6 * var(--pixel));">
                        Cash: $<input type="number" id="trade-my-cash" value="0" min="0"
                            style="width: calc(60 * var(--pixel)); font-size: calc(8 * var(--pixel));">
                    </div>
                </div>
                <div class="trade-col">
                    <div id="trade-req-label"
                        style="color: var(--highlight-color); margin-bottom: calc(4 * var(--pixel));">Requested</div>
                    <div id="trade-their-props"></div>
                    <div style="margin-top: calc(6 * var(--pixel));">
                        Cash: $<input type="number" id="trade-their-cash" value="0" min="0"
                            style="width: calc(60 * var(--pixel)); font-size: calc(8 * var(--pixel));">
                    </div>
                </div>
            </div>

            <div class="controls" style="margin-top: calc(10 * var(--pixel));">
                <button id="btn-send-deal" onclick="proposeDeal()" class="action-btn">Send Offer</button>
                <button id="btn-cancel-deal" onclick="closeTradeModal()">Cancel</button>
            </div>
        </div>

        <!-- LOG HISTORY (Bottom) -->
        <div class="history-section">
            <div id="log-history-title"
                style="font-size:calc(5 * var(--pixel)); color:#555; margin-bottom:calc(2 * var(--pixel));">HISTORY LOG
            </div>
            <div id="log-container"></div>
        </div>
    </div>

    <script>
        // --- LOCALIZATION ---
        const LOCALES = {
            en: {
                welcome: "Welcome to the family. The war begins.",
                waiting: "Waiting for the Boss to move...",
                buy: "Buy Turf",
                expand: "Add Muscle",
                hub: "Build Hub",
                deal: "Make Deal",
                end: "End Turn",
                bail: "Pay Bribe ($50)",
                cash: "CASH",
                turf: "TURF",
                pinched: "[PINCHED]",
                rolling: "Rolling the bones...",
                turn: "Turn: Boss",
                doubles: "Doubles!",
                escape: "You slipped past the guards!",
                max_jail: "Max turns in cooler. You bribed the guards ($50) and walked out.",
                failed_escape: "Failed Escape. Still in the cooler. Attempt",
                passed_go: "Paid respects to The Don. Picked up your cut ($200).",
                up_for_grabs: "This territory is up for grabs. Price:",
                too_expensive: "Too expensive.",
                your_turf: "Your turf.",
                paid_rent: "Kicking up tribute:",
                laundering: "Laundering operation costs:",
                raid: "IT'S A RAID! The Feds picked you up.",
                safe: "Safe haven.",
                visiting: "Just visiting.",
                lie_low: "Mattresses. Lie low.",
                sit_down: "SIT DOWN: Offer from Boss",
                accept: "Accept Deal",
                decline: "Decline Deal",
                offer: "They offer:",
                want: "They want:",
                no_turf: "No Turf",
                propose_title: "Sit Down with another Boss",
                deal_with: "Deal with:",
                your_offer: "Your Offer",
                requested: "Requested",
                send_offer: "Send Offer",
                cancel: "Cancel",
                bankrupt: "IS BANKRUPT!",
                winner: "is the Capo di tutti i capi!",
                history: "HISTORY LOG",
                buy_success: "Acquired",
                expand_success: "Expansion Successful.",
                improv_msg: "You've established"
            },
            de: {
                welcome: "Willkommen in der Familie. Der Krieg beginnt.",
                waiting: "Warte auf den Boss...",
                buy: "Gebiet kaufen",
                expand: "Verstärkung holen",
                hub: "Zentrum bauen",
                deal: "Deal machen",
                end: "Zug beenden",
                bail: "Bestechung zahlen ($50)",
                cash: "BARGELD",
                turf: "GEBIET",
                pinched: "[VERHAFTET]",
                rolling: "Die Würfel fallen...",
                turn: "Zug: Boss",
                doubles: "Pasch!",
                escape: "Du bist den Wachen entwischt!",
                max_jail: "Zeit abgesessen. Wachen bestochen ($50) und rausspaziert.",
                failed_escape: "Flucht gescheitert. Immer noch im Bau. Versuch",
                passed_go: "Dem Don Respekt gezollt. Deinen Anteil abgeholt ($200).",
                up_for_grabs: "Dieses Gebiet steht zum Verkauf. Preis:",
                too_expensive: "Zu teuer.",
                your_turf: "Dein Revier.",
                paid_rent: "Tribut gezahlt:",
                laundering: "Geldwäschekosten:",
                raid: "RAZZIA! Die Bundesbeamten haben dich geschnappt.",
                safe: "Sicherer Hafen.",
                visiting: "Nur zu Besuch.",
                lie_low: "Matratzenlager. Untertauchen.",
                sit_down: "BESPRECHUNG: Angebot von Boss",
                accept: "Deal annehmen",
                decline: "Deal ablehnen",
                offer: "Sie bieten:",
                want: "Sie wollen:",
                no_turf: "Kein Gebiet",
                propose_title: "Besprechung mit einem anderen Boss",
                deal_with: "Verhandle mit:",
                your_offer: "Dein Angebot",
                requested: "Gefordert",
                send_offer: "Angebot senden",
                cancel: "Abbrechen",
                bankrupt: "IST PLEITE!",
                winner: "ist der Capo di tutti i capi!",
                history: "HISTORIE",
                buy_success: "Erworben:",
                expand_success: "Erweiterung erfolgreich.",
                improv_msg: "Du hast aufgebaut:"
            },
            tr: {
                welcome: "Aileye hoş geldin. Savaş başlıyor.",
                waiting: "Patronun hamlesi bekleniyor...",
                buy: "Bölge Satın Al",
                expand: "Eleman Ekle",
                hub: "Merkez Kur",
                deal: "Anlaşma Yap",
                end: "Turu Bitir",
                bail: "Rüşvet Öde ($50)",
                cash: "NAKİT",
                turf: "BÖLGE",
                pinched: "[YAKALANDI]",
                rolling: "Zarlar atılıyor...",
                turn: "Sıra: Patron",
                doubles: "Çift!",
                escape: "Gardiyanları atlatıp kaçtın!",
                max_jail: "Hapis süresi doldu. Gardiyanlara rüşvet ($50) verip çıktın.",
                failed_escape: "Kaçış başarısız. Hala içeridesin. Deneme",
                passed_go: "Don'a saygılarını sundun. Payını aldın ($200).",
                up_for_grabs: "Bu bölge boşta. Fiyat:",
                too_expensive: "Çok pahalı.",
                your_turf: "Senin bölgen.",
                paid_rent: "Haraç ödendi:",
                laundering: "Para aklama masrafları:",
                raid: "BASKIN! Federal polis seni paketledi.",
                safe: "Güvenli liman.",
                visiting: "Sadece ziyaret.",
                lie_low: "Yataklar. İzini kaybettir.",
                sit_down: "TOPLANTI: Patron gönderdi:",
                accept: "Anlaşmayı Kabul Et",
                decline: "Reddet",
                offer: "Teklifleri:",
                want: "İstedikleri:",
                no_turf: "Bölge Yok",
                propose_title: "Başka bir Patronla masaya otur",
                deal_with: "Kiminle:",
                your_offer: "Senin Teklifin",
                requested: "İstenen",
                send_offer: "Teklif Gönder",
                cancel: "İptal",
                bankrupt: "İFLAS ETTİ!",
                winner: "artık Patronların Patronu!",
                history: "GEÇMİŞ",
                buy_success: "Satın alındı:",
                expand_success: "Genişleme başarılı.",
                improv_msg: "Kuruldu:"
            }
        };

        function t(key, lang) {
            return LOCALES[lang || 'en'][key] || LOCALES['en'][key];
        }

        // --- ASSETS ---
        const ASSETS = {
            mansion: "01_Mansion.jpg",
            divebar: "02_Bar.jpg"
        };

        // --- GAME DATA ---
        const BOARD = [
            { name: "The Don's Mansion (GO)", type: "GO" },
            { name: "Dive Bar", price: 60, rentList: [2, 10, 30, 90, 160, 250], housePrice: 50, type: "PROP", group: "Brown" },
            { name: "The Hit List", type: "CARD" },
            { name: "Pawn Shop", price: 60, rentList: [4, 20, 60, 180, 320, 450], housePrice: 50, type: "PROP", group: "Brown" },
            { name: "Laundering Fee", amount: 200, type: "TAX" },
            { name: "Trucking Route", price: 200, baseRent: 25, type: "RAIL" },
            { name: "Tenement Block", price: 100, rentList: [6, 30, 90, 270, 400, 550], housePrice: 50, type: "PROP", group: "L.Blue" },
            { name: "Favors", type: "CARD" },
            { name: "Meat Packing Plant", price: 100, rentList: [6, 30, 90, 270, 400, 550], housePrice: 50, type: "PROP", group: "L.Blue" },
            { name: "Speak Easy", price: 120, rentList: [8, 40, 100, 300, 450, 600], housePrice: 50, type: "PROP", group: "L.Blue" },
            { name: "Jail (Just Visiting)", type: "JAIL" },
            { name: "Boxing Gym", price: 140, rentList: [10, 50, 150, 450, 625, 750], housePrice: 100, type: "PROP", group: "Pink" },
            { name: "Waste Management", price: 150, type: "UTIL" },
            { name: "Gambling Den", price: 140, rentList: [10, 50, 150, 450, 625, 750], housePrice: 100, type: "PROP", group: "Pink" },
            { name: "Nightclub", price: 160, rentList: [12, 60, 180, 500, 700, 900], housePrice: 100, type: "PROP", group: "Pink" },
            { name: "Harbor Route", price: 200, baseRent: 25, type: "RAIL" },
            { name: "Construction Yard", price: 180, rentList: [14, 70, 200, 550, 750, 950], housePrice: 100, type: "PROP", group: "Orange" },
            { name: "Favors", type: "CARD" },
            { name: "Union Hall", price: 180, rentList: [14, 70, 200, 550, 750, 950], housePrice: 100, type: "PROP", group: "Orange" },
            { name: "Cement Factory", price: 200, rentList: [16, 80, 220, 600, 800, 1000], housePrice: 100, type: "PROP", group: "Orange" },
            { name: "Mattresses (Free Parking)", type: "SAFE" },
            { name: "Gentlemen's Club", price: 220, rentList: [18, 90, 250, 700, 875, 1050], housePrice: 150, type: "PROP", group: "Red" },
            { name: "The Hit List", type: "CARD" },
            { name: "Opera House", price: 220, rentList: [18, 90, 250, 700, 875, 1050], housePrice: 150, type: "PROP", group: "Red" },
            { name: "Downtown Hotel", price: 240, rentList: [20, 100, 300, 750, 925, 1100], housePrice: 150, type: "PROP", group: "Red" },
            { name: "Airport Route", price: 200, baseRent: 25, type: "RAIL" },
            { name: "City Hall", price: 260, rentList: [22, 110, 330, 800, 975, 1150], housePrice: 150, type: "PROP", group: "Yellow" },
            { name: "Distillery", price: 260, rentList: [22, 110, 330, 800, 975, 1150], housePrice: 150, type: "PROP", group: "Yellow" },
            { name: "Power Grid", price: 150, type: "UTIL" },
            { name: "Stock Exchange", price: 280, rentList: [24, 120, 360, 850, 1025, 1200], housePrice: 150, type: "PROP", group: "Yellow" },
            { name: "GO TO JAIL", type: "GOTOJAIL" },
            { name: "Suburban Estate", price: 300, rentList: [26, 130, 390, 900, 1100, 1275], housePrice: 200, type: "PROP", group: "Green" },
            { name: "Golf Course", price: 300, rentList: [26, 130, 390, 900, 1100, 1275], housePrice: 200, type: "PROP", group: "Green" },
            { name: "Favors", type: "CARD" },
            { name: "Private Island", price: 320, rentList: [28, 150, 450, 1000, 1200, 1400], housePrice: 200, type: "PROP", group: "Green" },
            { name: "Train Line Route", price: 200, baseRent: 25, type: "RAIL" },
            { name: "The Hit List", type: "CARD" },
            { name: "Luxury Marina", price: 350, rentList: [35, 175, 500, 1100, 1300, 1500], housePrice: 200, type: "PROP", group: "D.Blue" },
            { name: "Bribe The Mayor", amount: 100, type: "TAX" },
            { name: "The Casino", price: 400, rentList: [50, 200, 600, 1400, 1700, 2000], housePrice: 200, type: "PROP", group: "D.Blue" },
        ];

        // --- STATE ---
        let state = {
            players: [],
            currentPlayerIdx: 0,
            gameStarted: false,
            phase: 'ROLL', // ROLL, BUY_DECISION, IMPROVE, END, TRADE_RESPONSE
            propData: {}, // { propName: { muscle: 0 } }
            pendingDeals: [], // [{ from, to, offerProps, offerMoney, reqProps, reqMoney }]
            log: []
        };

        // --- SETUP LOGIC ---
        const numInput = document.getElementById('num-players');
        const nameArea = document.getElementById('name-inputs');

        numInput.addEventListener('change', () => {
            nameArea.innerHTML = '';
            const n = parseInt(numInput.value);
            for (let i = 0; i < n; i++) {
                nameArea.innerHTML += `
                <div style="display:flex; gap: calc(5 * var(--pixel)); align-items:center;">
                    <input type="text" id="pname-${i}" placeholder="Boss Name ${i + 1}" value="Boss ${i + 1}">
                    <select id="plang-${i}">
                        <option value="en">EN</option>
                        <option value="de">DE</option>
                        <option value="tr">TR</option>
                    </select>
                </div>`;
            }
        });
        numInput.dispatchEvent(new Event('change'));

        function startGame() {
            const n = parseInt(numInput.value);
            state.players = [];
            for (let i = 0; i < n; i++) {
                let name = document.getElementById(`pname-${i}`).value || `Boss ${i + 1}`;
                let plLang = document.getElementById(`plang-${i}`).value;
                state.players.push({
                    name: name,
                    money: 1500,
                    pos: 0,
                    properties: [],
                    inJail: false,
                    jailTurns: 0,
                    bankrupt: false,
                    lang: plLang,
                    color: `hsl(${i * 360 / n}, 70%, 50%)`
                });
            }
            BOARD.forEach(b => {
                if (b.type === 'PROP' || b.type === 'RAIL' || b.type === 'UTIL') state.propData[b.name] = { muscle: 0 };
            });

            state.gameStarted = true;
            document.getElementById('setup-screen').classList.add('hidden');
            document.getElementById('game-ui').style.display = 'flex';
            log(t('welcome', state.players[0].lang));
            startTurnLogic();
        }

        // --- STORY ENGINE ---
        function setStory(main, sub) {
            document.getElementById('story-text-main').innerHTML = main;
            document.getElementById('story-text-sub').innerHTML = sub || "";
        }

        // --- CORE GAMEPLAY ---
        function getCurrentPlayer() {
            return state.players[state.currentPlayerIdx];
        }

        function startTurnLogic() {
            let p = getCurrentPlayer();
            let incomingDeal = state.pendingDeals.find(d => d.to === state.currentPlayerIdx);
            if (incomingDeal) {
                state.phase = 'TRADE_RESPONSE';
                showDeal(incomingDeal);
                return;
            }

            setStory(`${t('turn', p.lang)} ${p.name}`, t('rolling', p.lang));

            setTimeout(() => {
                let d1 = Math.floor(Math.random() * 6) + 1;
                let d2 = Math.floor(Math.random() * 6) + 1;
                let total = d1 + d2;
                let isDoubles = (d1 === d2);

                if (p.inJail) {
                    if (isDoubles) {
                        setStory(t('doubles', p.lang), t('escape', p.lang));
                        log(`${t('doubles', p.lang)} ${t('escape', p.lang)}`);
                        p.inJail = false;
                        p.jailTurns = 0;
                        setTimeout(() => movePlayer(p, total), 1000);
                    } else {
                        p.jailTurns++;
                        if (p.jailTurns >= 3) {
                            p.money -= 50;
                            p.inJail = false;
                            p.jailTurns = 0;
                            setStory(t('max_jail', p.lang), "");
                            log(t('max_jail', p.lang));
                            setTimeout(() => movePlayer(p, total), 1000);
                        } else {
                            setStory(t('failed_escape', p.lang), `${t('failed_escape', p.lang)} ${p.jailTurns}/3.`);
                            state.phase = 'END';
                            updateUI();
                        }
                    }
                } else {
                    movePlayer(p, total);
                }
            }, 800);
        }

        function movePlayer(p, steps) {
            let oldPos = p.pos;
            p.pos = (p.pos + steps) % BOARD.length;
            if (p.pos < oldPos) {
                p.money += 200;
                log(`<span class="log-good">${t('passed_go', p.lang)}</span>`);
            }
            handleLanding(p);
        }

        function handleLanding(p) {
            let space = BOARD[p.pos];
            let mainText = space.name.toUpperCase();
            let subText = "";
            state.phase = 'END';

            if (space.type === 'PROP' || space.type === 'RAIL' || space.type === 'UTIL') {
                let owner = getOwner(space.name);
                if (!owner) {
                    if (p.money >= space.price) {
                        state.phase = 'BUY_DECISION';
                        subText = `${t('up_for_grabs', p.lang)} <span style="color:var(--highlight-color)">$${space.price}</span>.`;
                    } else {
                        subText = `${t('up_for_grabs', p.lang)} $${space.price}. ${t('too_expensive', p.lang)}`;
                    }
                } else if (owner === p) {
                    if (space.type === 'PROP' && ownsFullGroup(p, space.group)) {
                        let data = state.propData[space.name];
                        if (data.muscle < 5) {
                            state.phase = 'IMPROVE';
                            let buildText = data.muscle < 4 ? t('expand', p.lang) : t('hub', p.lang);
                            subText = `${t('your_turf', p.lang)} ${buildText} ($${space.housePrice}).`;
                        } else {
                            subText = t('your_turf', p.lang);
                        }
                    } else {
                        subText = t('your_turf', p.lang);
                    }
                } else {
                    let rent = calculateRent(space, owner);
                    subText = `<span class="log-bad">${t('paid_rent', p.lang)} $${rent} (${owner.name}).</span>`;
                    log(`${p.name} paid $${rent} to ${owner.name}.`);
                    transferMoney(p, owner, rent);
                }
            } else if (space.type === 'TAX') {
                subText = `<span class="log-bad">${t('laundering', p.lang)} $${space.amount}</span>`;
                p.money -= space.amount;
                checkBankruptcy(p);
            } else if (space.type === 'GOTOJAIL') {
                subText = `<span class="log-bad">${t('raid', p.lang)}</span>`;
                sendToJail(p);
            } else if (space.type === 'CARD') {
                subText = drawCard(p);
            } else if (space.type === 'GO') {
                subText = t('safe', p.lang);
            } else if (space.type === 'JAIL') {
                subText = t('visiting', p.lang);
            } else if (space.type === 'SAFE') {
                subText = t('lie_low', p.lang);
            }

            setStory(mainText, subText);
            updateUI();
        }

        function getOwner(propName) {
            return state.players.find(pl => pl.properties.includes(propName));
        }

        function calculateRent(space, owner) {
            if (space.type === 'PROP') {
                let data = state.propData[space.name];
                let rent = space.rentList[data.muscle];
                if (data.muscle === 0 && ownsFullGroup(owner, space.group)) rent *= 2;
                return rent;
            } else if (space.type === 'RAIL') {
                let count = state.players.reduce((acc, pl) => acc + (pl.properties.filter(pn => BOARD.find(b => b.name === pn && b.type === 'RAIL')).length), 0); // Simplified
                let ownerCount = owner.properties.filter(pn => {
                    let b = BOARD.find(x => x.name === pn);
                    return b && b.type === 'RAIL';
                }).length;
                return 25 * Math.pow(2, ownerCount - 1);
            } else if (space.type === 'UTIL') {
                let ownerCount = owner.properties.filter(pn => {
                    let b = BOARD.find(x => x.name === pn);
                    return b && b.type === 'UTIL';
                }).length;
                let roll = Math.floor(Math.random() * 10) + 2;
                return ownerCount === 1 ? roll * 4 : roll * 10;
            }
            return 0;
        }

        function transferMoney(from, to, amount) {
            from.money -= amount;
            to.money += amount;
            checkBankruptcy(from);
        }

        function checkBankruptcy(p) {
            if (p.money < 0) {
                log(`<span class="log-bad">BOSS ${p.name.toUpperCase()} ${t('bankrupt', p.lang)}</span>`);
                p.bankrupt = true;
            }
        }

        function sendToJail(p) {
            p.pos = 10;
            p.inJail = true;
            p.jailTurns = 0;
            state.phase = 'END';
        }

        function buyProperty() {
            let p = getCurrentPlayer();
            let space = BOARD[p.pos];
            if (p.money >= space.price) {
                p.money -= space.price;
                p.properties.push(space.name);
                log(`${t('buy_success', p.lang)} ${space.name}.`);
                state.phase = 'END';
                updateUI();
            }
        }

        function expandRacket() {
            let p = getCurrentPlayer();
            let space = BOARD[p.pos];
            let data = state.propData[space.name];
            if (p.money >= space.housePrice && data.muscle < 5) {
                p.money -= space.housePrice;
                data.muscle++;
                log(`${t('expand_success', p.lang)} ${space.name}.`);
                state.phase = 'END';
                updateUI();
            }
        }

        function ownsFullGroup(player, group) {
            if (!group) return false;
            return BOARD.filter(b => b.group === group).every(b => player.properties.includes(b.name));
        }

        function drawCard(p) {
            const cards = [
                { msg: "Tax refund. Collect $50.", amt: 50 },
                { msg: "Doctor's fee. Pay $50.", amt: -50 },
                { msg: "Inheritance. Collect $100.", amt: 100 }
            ];
            let c = cards[Math.floor(Math.random() * cards.length)];
            p.money += c.amt;
            log(`${p.name}: ${c.msg}`);
            return c.msg;
        }

        // --- TRADE ---
        function openTradeModal() {
            let p = getCurrentPlayer();
            let targetSel = document.getElementById('trade-target');
            targetSel.innerHTML = "";
            state.players.forEach((pl, idx) => {
                if (idx !== state.currentPlayerIdx && !pl.bankrupt) {
                    targetSel.innerHTML += `<option value="${idx}">${pl.name}</option>`;
                }
            });

            document.getElementById('trade-overlay').classList.remove('hidden');
            document.getElementById('trade-modal').classList.remove('hidden');
            updateTradeUI();
        }

        function closeTradeModal() {
            document.getElementById('trade-overlay').classList.add('hidden');
            document.getElementById('trade-modal').classList.add('hidden');
        }

        function updateTradeUI() {
            let p = getCurrentPlayer();
            let lang = p.lang;
            document.getElementById('trade-title').innerText = t('propose_title', lang);
            document.getElementById('trade-off-label').innerText = t('your_offer', lang);
            document.getElementById('trade-req-label').innerText = t('requested', lang);
            document.getElementById('btn-send-deal').innerText = t('send_offer', lang);
            document.getElementById('btn-cancel-deal').innerText = t('cancel', lang);

            let myProps = document.getElementById('trade-my-props');
            myProps.innerHTML = "";
            p.properties.forEach(pn => {
                myProps.innerHTML += `<label class="prop-item"><input type="checkbox" value="${pn}">${pn}</label>`;
            });

            let targetIdx = parseInt(document.getElementById('trade-target').value);
            let targetP = state.players[targetIdx];
            let theirProps = document.getElementById('trade-their-props');
            theirProps.innerHTML = "";
            if (targetP) {
                targetP.properties.forEach(pn => {
                    theirProps.innerHTML += `<label class="prop-item"><input type="checkbox" value="${pn}">${pn}</label>`;
                });
            }
        }

        document.getElementById('trade-target').addEventListener('change', updateTradeUI);

        function proposeDeal() {
            let p = getCurrentPlayer();
            let targetIdx = parseInt(document.getElementById('trade-target').value);
            let offerCash = parseInt(document.getElementById('trade-my-cash').value) || 0;
            let reqCash = parseInt(document.getElementById('trade-their-cash').value) || 0;

            let offerProps = Array.from(document.getElementById('trade-my-props').querySelectorAll('input:checked')).map(i => i.value);
            let reqProps = Array.from(document.getElementById('trade-their-props').querySelectorAll('input:checked')).map(i => i.value);

            state.pendingDeals.push({ from: state.currentPlayerIdx, to: targetIdx, offerCash, reqCash, offerProps, reqProps });
            closeTradeModal();
            log(`Deal proposed to ${state.players[targetIdx].name}.`);
        }

        function showDeal(deal) {
            let fromP = state.players[deal.from];
            let toP = state.players[deal.to];
            let main = `${t('sit_down', toP.lang)} ${fromP.name}`;
            let sub = `${t('offer', toP.lang)} $${deal.offerCash} & [${deal.offerProps.join(", ") || t('no_turf', toP.lang)}]<br>`;
            sub += `${t('want', toP.lang)} $${deal.reqCash} & [${deal.reqProps.join(", ") || t('no_turf', toP.lang)}]`;
            setStory(main, sub);

            let buyBtn = document.getElementById('btn-buy');
            buyBtn.innerText = t('accept', toP.lang);
            buyBtn.onclick = () => acceptDeal(deal);
            buyBtn.disabled = false;
            buyBtn.classList.remove('hidden');

            let endBtn = document.getElementById('btn-end');
            endBtn.innerText = t('decline', toP.lang);
            endBtn.onclick = () => declineDeal(deal);
            endBtn.disabled = false;
        }

        function acceptDeal(deal) {
            let fromP = state.players[deal.from];
            let toP = state.players[deal.to];
            if (toP.money < deal.reqCash || fromP.money < deal.offerCash) {
                alert("Boss, someone's light on cash.");
                declineDeal(deal);
                return;
            }
            fromP.money -= deal.offerCash; toP.money += deal.offerCash;
            toP.money -= deal.reqCash; fromP.money += deal.reqCash;

            deal.offerProps.forEach(pn => {
                fromP.properties = fromP.properties.filter(n => n !== pn);
                toP.properties.push(pn);
            });
            deal.reqProps.forEach(pn => {
                toP.properties = toP.properties.filter(n => n !== pn);
                fromP.properties.push(pn);
            });

            log("A deal was struck.");
            state.pendingDeals = state.pendingDeals.filter(d => d !== deal);
            resetButtons();
            startTurnLogic();
        }

        function declineDeal(deal) {
            log("Deal rejected.");
            state.pendingDeals = state.pendingDeals.filter(d => d !== deal);
            resetButtons();
            startTurnLogic();
        }

        function resetButtons() {
            let p = getCurrentPlayer();
            let buyBtn = document.getElementById('btn-buy');
            buyBtn.innerText = t('buy', p.lang);
            buyBtn.onclick = buyProperty;
            let endBtn = document.getElementById('btn-end');
            endBtn.innerText = t('end', p.lang);
            endBtn.onclick = endTurn;
        }

        function endTurn() {
            let startIdx = state.currentPlayerIdx;
            do {
                state.currentPlayerIdx = (state.currentPlayerIdx + 1) % state.players.length;
            } while (state.players[state.currentPlayerIdx].bankrupt && state.currentPlayerIdx !== startIdx);

            let active = state.players.filter(pl => !pl.bankrupt);
            if (active.length === 1) {
                alert(`GAME OVER! ${active[0].name} ${t('winner', active[0].lang)}`);
                return;
            }
            startTurnLogic();
        }

        // --- UI ---
        function log(msg) {
            let div = document.createElement('div');
            div.innerHTML = `> ${msg}`;
            let container = document.getElementById('log-container');
            container.appendChild(div);
            container.scrollTop = container.scrollHeight;
        }

        function updateUI() {
            if (!state.gameStarted) return;
            let p = getCurrentPlayer();
            let space = BOARD[p.pos];

            let bg = ASSETS.divebar;
            if (space.type === 'GO' || (space.group && ['Green', 'D.Blue', 'Yellow', 'Red'].includes(space.group))) bg = ASSETS.mansion;
            document.body.style.backgroundImage = `url('${bg}')`;

            let header = document.getElementById('stats-header');
            header.innerHTML = "";
            state.players.forEach((pl, idx) => {
                let card = document.createElement('div');
                card.className = `player-stat-card ${idx === state.currentPlayerIdx ? 'active' : ''}`;
                if (pl.bankrupt) card.style.opacity = "0.4";
                card.innerHTML = `
                    <div style="color:${pl.color}; margin-bottom:calc(2*var(--pixel));">${pl.name}</div>
                    <div>${t('cash', p.lang)}: $${pl.money}</div>
                    <div>${t('turf', p.lang)}: ${pl.properties.length}</div>
                    ${pl.inJail ? `<div style="color:var(--accent-color)">${t('pinched', p.lang)}</div>` : ''}
                `;
                header.appendChild(card);
            });

            // Buttons
            let buyBtn = document.getElementById('btn-buy');
            let endBtn = document.getElementById('btn-end');
            let tradeBtn = document.getElementById('btn-trade');

            if (state.phase !== 'TRADE_RESPONSE') {
                buyBtn.classList.toggle('hidden', state.phase !== 'BUY_DECISION' && state.phase !== 'IMPROVE');
                buyBtn.disabled = (state.phase !== 'BUY_DECISION' && state.phase !== 'IMPROVE');
                if (state.phase === 'IMPROVE') {
                    let data = state.propData[space.name];
                    buyBtn.innerText = data.muscle < 4 ? t('expand', p.lang) : t('hub', p.lang);
                    buyBtn.onclick = expandRacket;
                } else {
                    buyBtn.innerText = t('buy', p.lang);
                    buyBtn.onclick = buyProperty;
                }

                tradeBtn.innerText = t('deal', p.lang);
                tradeBtn.classList.toggle('hidden', state.phase === 'ROLL');

                endBtn.innerText = t('end', p.lang);
                endBtn.onclick = endTurn;
                endBtn.disabled = (state.phase !== 'END' && state.phase !== 'BUY_DECISION' && state.phase !== 'IMPROVE');
            }

            // Shortkeys
            const btns = Array.from(document.querySelectorAll('.controls button:not(.hidden)'));
            btns.forEach((btn, idx) => {
                const base = btn.innerText.replace(/^\d: /, "");
                btn.innerText = `${idx + 1}: ${base}`;
            });

            document.getElementById('log-history-title').innerText = t('history', p.lang);
        }

        window.addEventListener('keydown', (e) => {
            if (!state.gameStarted) return;
            if (['INPUT', 'SELECT'].includes(document.activeElement.tagName)) return;
            let idx = parseInt(e.key) - 1;
            let btns = Array.from(document.querySelectorAll('.controls button:not(.hidden)')).filter(b => !b.disabled);
            if (idx >= 0 && idx < btns.length) btns[idx].click();
        });

        function saveGame() {
            localStorage.setItem('omerta_save', JSON.stringify(state));
            alert("Saved.");
        }
        function loadGame() {
            let s = localStorage.getItem('omerta_save');
            if (s) {
                state = JSON.parse(s);
                document.getElementById('setup-screen').classList.add('hidden');
                document.getElementById('game-ui').style.display = 'flex';
                updateUI();
            }
        }
    </script>
</body>

</html>